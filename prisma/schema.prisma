generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanType {
  FREE
  PRO
}

enum TaskType {
  TASK
  GOAL
  NOTE
}

enum TaskStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

model User {
  id           String   @id @default(uuid())
  telegramId   BigInt   @unique
  username     String?
  firstName    String
  lastName     String?
  timezone     String   @default("UTC")
  planType     PlanType @default(FREE)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tasks        Task[]
  completions  TaskCompletion[]
}

model Task {
  id                String          @id @default(uuid())
  userId            String
  title             String
  description       String?
  type              TaskType        @default(TASK)
  status            TaskStatus      @default(ACTIVE)
  priority          Priority        @default(MEDIUM)
  dueDate           DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  recurringRuleId   String?
  generatedDate     DateTime?

  user              User            @relation(fields: [userId], references: [id])
  completions       TaskCompletion[]
  generatedByRule   RecurringRule?   @relation("GeneratedByRule", fields: [recurringRuleId], references: [id])
  recurring         RecurringRule?   @relation("TemplateTask")
  reminders         Reminder[]

  @@unique([recurringRuleId, generatedDate])
  @@index([userId])
  @@index([recurringRuleId])
}

model TaskCompletion {
  id          String   @id @default(uuid())
  taskId      String
  userId      String
  completedAt DateTime @default(now())

  task        Task     @relation(fields: [taskId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
}

model RecurringRule {
  id             String     @id @default(uuid())
  taskId         String     @unique
  frequency      Frequency
  interval       Int        @default(1)
  daysOfWeek     Int[]      // 1-7 (ISO weekday: Mon=1, Sun=7)
  endDate        DateTime?

  task           Task       @relation("TemplateTask", fields: [taskId], references: [id])
  generatedTasks Task[]     @relation("GeneratedByRule")
}

model Reminder {
  id        String   @id @default(uuid())
  taskId    String
  remindAt  DateTime
  sent      Boolean  @default(false)

  task      Task     @relation(fields: [taskId], references: [id])

  @@index([taskId])
  @@index([remindAt])
  @@index([sent])
}

